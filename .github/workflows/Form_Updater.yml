name: Daily Racing Form Update

on:
  schedule:
    # Runs at 9:00 AM ACST (23:30 UTC for standard time)
    # ACST is UTC+9:30, so 9:00 AM ACST = 11:30 PM UTC previous day
    - cron: '30 23 * * *'
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  scrape-racing-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Get current date
        id: date
        run: |
          echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S ACST')" >> $GITHUB_OUTPUT

      - name: Remove previous racing data
        run: |
          rm -rf racing_data/
          echo "âœ“ Previous data cleared"

      - name: Run racing scraper
        env:
          SCRAPER_EMAIL: ${{ secrets.LADBROKES_EMAIL }}
          SCRAPER_PARTNER: ${{ secrets.LADBROKES_PARTNER }}
        run: |
          python ladbrokes_racing_scraper.py
        continue-on-error: false

      - name: Verify data was scraped
        run: |
          if [ -d "racing_data" ] && [ "$(ls -A racing_data)" ]; then
            echo "âœ“ Racing data successfully scraped"
            echo "Folders created:"
            ls -la racing_data/
          else
            echo "âœ— No data was scraped"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push changes
        run: |
          git add racing_data/
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ‡ Daily racing form update - ${{ steps.date.outputs.timestamp }}"
            git push
            echo "âœ“ Changes pushed successfully"
          fi

      - name: Generate summary
        run: |
          echo "## ðŸ‡ Daily Racing Form Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: ${{ steps.date.outputs.today }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: ${{ steps.date.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "racing_data/${{ steps.date.outputs.today }}/summary.json" ]; then
            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            MEETINGS=$(python -c "import json; f=open('racing_data/${{ steps.date.outputs.today }}/summary.json'); d=json.load(f); print(d['total_meetings'])")
            RACES=$(python -c "import json; f=open('racing_data/${{ steps.date.outputs.today }}/summary.json'); d=json.load(f); print(d['total_races'])")
            echo "- **Total Meetings**: $MEETINGS" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Races**: $RACES" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Scraping failed - check logs above" >> $GITHUB_STEP_SUMMARY
