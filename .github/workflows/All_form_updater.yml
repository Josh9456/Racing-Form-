name: Daily Racing Form Update (Enhanced)

on:
  schedule:
    # Runs at 9:00 AM ACST (23:30 UTC for standard time)
    # ACST is UTC+9:30, so 9:00 AM ACST = 11:30 PM UTC previous day
    - cron: '30 23 * * *'
  workflow_dispatch:  # Manual trigger with custom inputs
    inputs:
      countries:
        description: 'Countries to scrape (comma-separated)'
        required: false
        default: 'AUS'
        type: choice
        options:
          - 'AUS'
          - 'AUS,HKG'
          - 'AUS,HKG,SGP'
          - 'AUS,HKG,SGP,JPN'
          - 'AUS,NZL'
          - 'HKG'
          - 'SGP'
          - 'GBR,IRL'
          - 'USA'
          - 'ALL'
      categories:
        description: 'Race categories (T=Thoroughbred, G=Greyhound, H=Harness)'
        required: false
        default: 'T,G'
        type: choice
        options:
          - 'T,G'
          - 'T'
          - 'G'
          - 'H'
          - 'T,G,H'
      date_override:
        description: 'Date to scrape (YYYY-MM-DD format, leave empty for today)'
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: racing-form-update
  cancel-in-progress: true

jobs:
  scrape-racing-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Get current date and inputs
        id: config
        run: |
          # Determine date to scrape
          if [ -n "${{ inputs.date_override }}" ]; then
            SCRAPE_DATE="${{ inputs.date_override }}"
          else
            SCRAPE_DATE=$(date +'%Y-%m-%d')
          fi
          echo "date=$SCRAPE_DATE" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S ACST')" >> $GITHUB_OUTPUT
          
          # Determine countries (default to AUS for scheduled runs)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            COUNTRIES="${{ inputs.countries }}"
          else
            COUNTRIES="AUS"
          fi
          echo "countries=$COUNTRIES" >> $GITHUB_OUTPUT
          
          # Determine categories (default to T,G for scheduled runs)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            CATEGORIES="${{ inputs.categories }}"
          else
            CATEGORIES="T,G"
          fi
          echo "categories=$CATEGORIES" >> $GITHUB_OUTPUT
          
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $SCRAPE_DATE" >> $GITHUB_STEP_SUMMARY
          echo "- **Countries**: $COUNTRIES" >> $GITHUB_STEP_SUMMARY
          echo "- **Categories**: $CATEGORIES" >> $GITHUB_STEP_SUMMARY

      - name: Remove previous racing data
        run: |
          rm -rf racing_data/
          echo "âœ“ Previous data cleared"

      - name: Create scraper runner script
        run: |
          cat > run_scraper.py << 'EOFPYTHON'
          import os
          import sys
          from scraper import LadbrokesRacingScraper
          
          # Get configuration from environment
          email = os.getenv('SCRAPER_EMAIL')
          partner = os.getenv('SCRAPER_PARTNER')
          date = os.getenv('SCRAPE_DATE')
          countries_str = os.getenv('SCRAPE_COUNTRIES', 'AUS')
          categories_str = os.getenv('SCRAPE_CATEGORIES', 'T,G')
          
          # Parse countries and categories
          if countries_str == 'ALL':
              countries = 'ALL'
          else:
              countries = [c.strip() for c in countries_str.split(',')]
          
          categories = [c.strip() for c in categories_str.split(',')]
          
          print(f"Scraping with configuration:")
          print(f"  Date: {date}")
          print(f"  Countries: {countries}")
          print(f"  Categories: {categories}")
          
          # Run scraper
          # Note: Assuming scraper.py is in the root and class is LadbrokesRacingScraper
          scraper = LadbrokesRacingScraper(email, partner)
          scraper.scrape_and_save(
              date=date,
              interactive=False,
              countries=countries,
              categories=categories
          )
          EOFPYTHON

      - name: Run racing scraper
        env:
          SCRAPER_EMAIL: ${{ secrets.LADBROKES_EMAIL }}
          SCRAPER_PARTNER: ${{ secrets.LADBROKES_PARTNER }}
          SCRAPE_DATE: ${{ steps.config.outputs.date }}
          SCRAPE_COUNTRIES: ${{ steps.config.outputs.countries }}
          SCRAPE_CATEGORIES: ${{ steps.config.outputs.categories }}
        run: |
          python run_scraper.py
        continue-on-error: false

      - name: Verify data was scraped
        run: |
          if [ -d "racing_data" ] && [ "$(ls -A racing_data)" ]; then
            echo "âœ“ Racing data successfully scraped"
            echo "Folders created:"
            ls -la racing_data/
          else
            echo "âœ— No data was scraped"
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push changes
        run: |
          git add racing_data/
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ‡ Racing form update - ${{ steps.config.outputs.timestamp }} [${{ steps.config.outputs.countries }}]"
            
            # Pull remote changes and rebase before pushing
            git pull --rebase origin main || git pull --rebase origin master
            
            git push
            echo "âœ“ Changes pushed successfully"
          fi

      - name: Generate summary
        run: |
          echo "## ðŸ‡ Racing Form Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: ${{ steps.config.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: ${{ steps.config.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "**Countries**: ${{ steps.config.outputs.countries }}" >> $GITHUB_STEP_SUMMARY
          echo "**Categories**: ${{ steps.config.outputs.categories }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "racing_data/${{ steps.config.outputs.date }}/summary.json" ]; then
            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            MEETINGS=$(python -c "import json; f=open('racing_data/${{ steps.config.outputs.date }}/summary.json'); d=json.load(f); print(d['total_meetings'])")
            RACES=$(python -c "import json; f=open('racing_data/${{ steps.config.outputs.date }}/summary.json'); d=json.load(f); print(d['total_races'])")
            echo "- **Total Meetings**: $MEETINGS" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Races**: $RACES" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Scraping failed - check logs above" >> $GITHUB_STEP_SUMMARY
